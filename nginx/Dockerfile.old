FROM nginx:alpine

# התקנת fail2ban, iptables ו-rsyslog
RUN apk add --no-cache \
    fail2ban \
    iptables \
    rsyslog \
    bash

# יצירת תיקיות ללוגים
RUN mkdir -p /var/log/nginx /var/log/fail2ban

# העתקת קובץ תצורה של nginx
COPY nginx.conf /etc/nginx/nginx.conf

# יצירת תיקייה לתצורות fail2ban
RUN mkdir -p /etc/fail2ban/filter.d /etc/fail2ban/jail.d

# העתקת תצורות fail2ban
COPY fail2ban/jail.local /etc/fail2ban/jail.local
COPY fail2ban/filter.d/nginx-auth.conf /etc/fail2ban/filter.d/nginx-auth.conf

# סקריפט התחלה
COPY start.sh /start.sh
RUN chmod +x /start.sh

EXPOSE 80

CMD ["/start.sh"]